<!DOCTYPE html>
<html class="t-grey">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Instalando DRBD</title>
  <meta name="description" content="Bienvenidos aventureros.En este post vamos a aprender a instalar DRBD. .En cada nodo tendremos un disco vacio y completamente dedicado a DRBD, por lo tanto u...">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href='https://fonts.googleapis.com/css?family=Roboto:400,400italic,700|Roboto+Mono:400,500' rel='stylesheet' type='text/css'>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/2018/01/Instalando-DRBD">
  <link rel="alternate" type="application/rss+xml" title="TinoUY" href="http://localhost:4000/feed.xml">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-7765886811341988",
            enable_page_level_ads: true
       });
  </script>


</head>

  <body>
    
<style>

.topnav {
  overflow: hidden;
}

.topnav a {
  float: left;
  display: block;
}

.topnav .icon {
  display: none;
}

.topnav a:hover, .dropdown:hover .dropbtn {
  color: white;
}

.dropdown-content a:hover {
  color: black;
}

.dropdown:hover .dropdown-content {
  display: block;
}

@media screen and (max-width: 600px) {
  .topnav a:not(:first-child), .dropdown .dropbtn {
    display: none;
  }
  .topnav a.icon {
    float: right;
    display: block;
  }
}

@media screen and (max-width: 600px) {
  .topnav.responsive {position: relative;}
  .topnav.responsive .icon {
    position: absolute;
  }
  .topnav.responsive a {
    float: none;
    display: block;
  }
  .topnav.responsive .dropdown {float: none;}
  .topnav.responsive .dropdown-content {position: relative;}
  .topnav.responsive .dropdown .dropbtn {
    display: block;
    width: 100%;
  }
}
</style>

<nav class="c-navigation is-fixed">
  <div class="c-navigation__container u-container topnav" id="myTopnav">
    <a class="c-navigation__item " href="/">Inicio</a>
    <a class="c-navigation__item " href="/articulos/">Articulos</a>
    <a class="c-navigation__item " href="/contacto/">Contacto</a>
    <a class="c-navigation__item " href="/about/">About</a>
    <a class="c-navigation__item search" href="/search/"><i class="material-icons">search</i></a>
    <a href="javascript:void(0);myFunction();" style="font-size:15px;" class="c-navigation__item icon" role="button" onclick="myFunction()"><i class="material-icons">menu</i></a>
  </div>
</nav>

<script>
function myFunction() {
  var x = document.getElementById("myTopnav");
  if (x.className === "topnav") {
    x.className += " responsive";
  } else {
    x.className = "topnav";
  }
}
</script>


    <article class="c-article">
  <header class="c-header c-article__header">
    <div class="u-container">
      <h1 class="c-header__title">Instalando DRBD</h1>
    </div>
  </header>

  <div class="c-article__main">
    <p>Bienvenidos aventureros.
En este post vamos a aprender a instalar DRBD. <!-- more -->.
En cada nodo tendremos un disco vacio y completamente dedicado a DRBD, por lo tanto usaremos este disco /dev/vda</p>

<h3 id="que-es-drbd-distributed-replicated-block-device">Que es DRBD (Distributed Replicated Block Device)?</h3>

<p>DRBD es un software que permite hacer replica de los datos de una particion o disco entre varias maquinas a traves de la red.</p>

<h3 id="entorno">Entorno</h3>
<hr />

<blockquote>
  <table>
    <tbody>
      <tr>
        <td>Nodo1</td>
        <td>drbd1</td>
        <td>192.168.10.10</td>
        <td>CentOS 7</td>
      </tr>
    </tbody>
  </table>

  <table>
    <tbody>
      <tr>
        <td>Nodo2</td>
        <td>drbd2</td>
        <td>192.168.10.11</td>
        <td>CentOS 7</td>
      </tr>
    </tbody>
  </table>
</blockquote>

<h3 id="instalando">Instalando</h3>
<p>Para comenzar con la instalación lo primero que haremos sera ir a una terminal de linux.
1 - Ejecutaremos los siguientes comandos para agregar el repositorio ELRepo en ambos nodos:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
# rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm
</code></pre></div></div>

<p>2 - Luego ejecutamos lo siguiente para instalar DRBD y los modulos del kernel necesarios para el funcionamiento de DRBD:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install drbd90-utils kmod-drbd90
</code></pre></div></div>

<p>Cuando finalice la instalación comprobaremos si el modulo del kernel fue cargado:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lsmod | <span class="nb">grep</span> <span class="nt">-i</span> drbd
</code></pre></div></div>

<p>Si no fue cargado automáticamente entonces ejecutamos:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>modprobe drbd
</code></pre></div></div>

<p><strong><em>Nota</em></strong></p>
<blockquote>
  <p>El comando modprobe cargara el modulo durante la sesión activa, para que el modulo se cargue en el inicio hay que utilizar el servicio <strong>systemd-modules-load</strong> creando un archivo dentro de <strong>/etc/modulesload.d/</strong> y de esta manera el modulo es cargado durante cada inicio del sistema.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo </span>drbd <span class="o">&gt;</span> /etc/modules-load.d/drbd.conf
</code></pre></div></div>

<h3 id="configurando-drbd">Configurando DRBD</h3>
<p>Luego de instalar DRBD de forma correcta lo que haremos sera cambiar la configuración global editando el archivo <strong>/etc/drbd.d/global_common.conf</strong>
1 - Vamos a hacer un backup del archivo original:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mv /etc/drbd.d/global_common.conf /etc/drbd.d/global_common.conf.orig
</code></pre></div></div>

<p>2 - Creamos un nuevo archivo de configuración global:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/drbd.d/global_common.conf
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>global {
 usage-count no;
}
common {
 net {
  protocol C;
 }
}
</code></pre></div></div>

<p>3 - Lo siguiente sera crear un archivo de configuración para el recurso <strong>drbd0</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/drbd.d/drbd0.res
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resource drbd0 {
	disk /dev/vda;
	device /dev/drbd0;
	meta-disk internal;
	on drbd1 {
		address 192.168.10.10:7789;
	}
	on drbd2 {
		address 192.168.10.11:7789;
	}
}
</code></pre></div></div>

<p><strong><em>Nota</em></strong></p>
<blockquote>
  <p>En el archivo de recurso de arriba hemos creado un nuevo recurso llamado drbd0, donde 192.168.10.10 y 192.168.10.11 son las IP de nuestros nodos y 7789 el puerto utilizado para la comunicación, usando el disco /dev/vda para crear el dispositivo /dev/drbd0.</p>
</blockquote>

<p>4 - Inicializar el dispositivo drbd0 en cada nodo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>drbdadm create-md drbd0
</code></pre></div></div>

<p>5 - Iniciar y habilitar el demonio drbd en ambos nodos:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start drbd
systemctl <span class="nb">enable </span>drbd
</code></pre></div></div>

<p>6 - Definamos el Nodo1 como nodo primario:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>drbdadm up drbd0
drbdadm primary drbd0
</code></pre></div></div>
<p><strong><em>Nota</em></strong></p>
<blockquote>
  <p>En caso de tener algún error para definir el nodo como primaro ejecutamos el mismo comando pero con el parámetro –force para forzar esta opcion.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>drbdadm primary drbd <span class="nt">--force</span>
</code></pre></div></div>

<p>7 - Para chequear el estado de la sincronización mientras se ejecuta utilizamos el siguiente comando:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>drbdadm status
</code></pre></div></div>

<p>8 - Ajustes de firewall en ambos nodos:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>firewall-cmd <span class="nt">--permanent</span> <span class="nt">--add-rich-rule</span><span class="o">=</span><span class="s1">'rule family="ipv4" source address="ip_nodo" port port="7789" protocol="tcp" accept'</span>
firewall-cmd <span class="nt">--reload</span>
</code></pre></div></div>

<h3 id="testeando-drbd">Testeando DRBD</h3>

<p>Para testear DRBD crearemos un filesystem, montaremos el volumen y crearemos archivos en el nodo primario <em>drbd1</em>, finalmente cambiaremos el nodo primario a <em>drbd2</em> y comprobaremos que DRBD funciona.
Con el siguiente comando crearemos un filesystem xfs en /dev/drbd0 y lo montaremos en /mnt/</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkfs.xfs /dev/drbd0
mount /dev/drbd0 /mnt
</code></pre></div></div>

<p>Crearemos archivos con</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>touch /mnt/file<span class="o">{</span>1..5<span class="o">}</span>
<span class="nb">ls</span> <span class="nt">-l</span> /mnt/
total 0
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root root 0 Sep 22 21:43 file1
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root root 0 Sep 22 21:43 file2
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root root 0 Sep 22 21:43 file3
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root root 0 Sep 22 21:43 file4
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root root 0 Sep 22 21:43 file5
</code></pre></div></div>

<p>Ahora cambiaremos el nodo primario de <em>drbd1</em> a <em>drbd2</em>
Primero desmontamos el volumen drbd0</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>umount /mnt
</code></pre></div></div>

<p>Cambiamos el Nodo1 de primario a secundario</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>drbdadm secondary drbd
</code></pre></div></div>

<p>Ahora cambiamos el Nodo2 de secundario a primario</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>drbdadm primary drbd
</code></pre></div></div>

<p>Montamos el filesystem y comprobamos que tenga los archivos dentro</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mount /dev/drbd0 /mnt
<span class="nb">ls</span> <span class="nt">-l</span>  /mnt
total 0
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root root 0 Sep 22 21:43 file1
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root root 0 Sep 22 21:43 file2
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root root 0 Sep 22 21:43 file3
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root root 0 Sep 22 21:43 file4
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root root 0 Sep 22 21:43 file5
</code></pre></div></div>



<div class="container">
  <div class="row">
    <div class="col-lg-8 col-md-10 mx-auto">
      <div id="disqus_thread"></div>
        <script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
          (function() { // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');
          s.src = 'https://tinouy.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </div>
</div>



  </div>
</article>


    <footer class="c-footer">
  <div class="u-container c-footer__container">
    <p>&copy; TinoUY 2019</p>
    <p>
      
      
      
      
    </p>
  </div>
</footer>

  </body>
</html>
